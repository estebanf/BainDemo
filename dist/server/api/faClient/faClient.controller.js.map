{"version":3,"sources":["api/faClient/faClient.controller.js"],"names":["index","show","upsert","create","getFiles","cb","query","q","limit","rows","fl","req","res","getFacets","response","body","status","send","params","id","files","map","JSON","parse","docs","value","item","docId","each","fields","obj","field","name","merge","fullPath","folder","join","fileName","text_NePos","sensitive","NE_SSN","uniq","ssnPos","filter","o","type","lenght","console","log","values","gloss","ids","find","where","in","exec","err","projectFiles","projectFileMatch","cs_uid","keep","entity","findOne","equals","save","moveFiles","chain","delFiles","command","project","archive"],"mappings":"AAAA;;;;;QAegBA,K,GAAAA,K;QAOAC,I,GAAAA,I;QAsDAC,M,GAAAA,M;QAiBAC,M,GAAAA,M;;AA5FhB;;;;AACA;;;;AAEA;;;;;;AACA,SAASC,QAAT,CAAkBC,EAAlB,EAAqB;AACnB,MAAIC,QAAQ;AACVC,OAAE,GADQ;AAEVC,WAAM,CAFI;AAGVC,UAAK,IAHK;AAIVC,QAAG;AAJO,GAAZ;AAMA,0BAASJ,KAAT,EAAeD,EAAf;AACD;AACD;AACO,SAASL,KAAT,CAAeW,GAAf,EAAoBC,GAApB,EAAyB;AAC9B,qBAASC,SAAT,CAAmB,UAASC,QAAT,EAAkBC,IAAlB,EAAuB;AACxCH,QAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBF,IAArB;AAED,GAHD;AAID;;AAEM,SAASd,IAAT,CAAcU,GAAd,EAAkBC,GAAlB,EAAsB;AAC3B,qBAASR,QAAT,CAAkBO,IAAIO,MAAJ,CAAWC,EAA7B,EAAgC,UAASL,QAAT,EAAkBC,IAAlB,EAAuB;AACrD,QAAIK,QAAQ,iBAAEC,GAAF,CAAMC,KAAKC,KAAL,CAAWR,IAAX,EAAiBS,IAAvB,EAA4B,UAASC,KAAT,EAAe;AACrD,UAAIC,OAAO,EAAEC,OAAOF,MAAME,KAAf,EAAX;AACA,uBAAEC,IAAF,CAAOH,MAAMI,MAAb,EAAoB,UAASC,GAAT,EAAa;AAC/B,YAAIC,QAAQ,EAAZ;AACAA,cAAMD,IAAIE,IAAV,IAAkBF,IAAIL,KAAtB;AACAC,eAAO,iBAAEO,KAAF,CAAQP,IAAR,EAAaK,KAAb,CAAP;AACD,OAJD;AAKAL,WAAKQ,QAAL,GAAgB,MAAMR,KAAKS,MAAL,CAAYC,IAAZ,CAAiB,GAAjB,CAAN,GAA8B,GAA9B,GAAoCV,KAAKW,QAAzD;AACA,UAAGX,KAAKY,UAAR,EAAoB;AAAEZ,aAAKY,UAAL,GAAkBhB,KAAKC,KAAL,CAAWG,KAAKY,UAAhB,CAAlB;AAA8C;AACpEZ,WAAKa,SAAL,GAAiB,KAAjB;AACA,UAAGb,KAAKc,MAAR,EAAe;AACbd,aAAKc,MAAL,GAAc,iBAAEC,IAAF,CAAOf,KAAKc,MAAZ,CAAd;AACAd,aAAKa,SAAL,GAAiB,IAAjB;AACD,OAHD,MAIK;AACD,YAAGb,KAAKY,UAAR,EAAmB;AACjB,cAAII,SAAS,iBAAEC,MAAF,CAASjB,KAAKY,UAAd,EAA0B,UAASM,CAAT,EAAY;AAAE,mBAAOA,EAAEC,IAAF,IAAU,QAAjB;AAA2B,WAAnE,CAAb;AACA,cAAGH,UAAUA,OAAOI,MAAP,GAAgB,CAA7B,EAA+B;AAC7BC,oBAAQC,GAAR,CAAYN,MAAZ;AACAhB,iBAAKc,MAAL,GAAc,iBAAEnB,GAAF,CAAMqB,OAAOO,MAAb,EAAoB,UAASL,CAAT,EAAY;AAAE,qBAAOA,EAAEM,KAAT;AAAgB,aAAlD,CAAd;AACAxB,iBAAKa,SAAL,GAAiB,IAAjB;AACD;AACF;AACJ;AACD,aAAOb,IAAP;AACD,KAzBW,CAAZ;AA0BA,QAAIyB,MAAM,iBAAE9B,GAAF,CAAMD,KAAN,EAAY,UAASU,GAAT,EAAa;AACjC,aAAOA,IAAIH,KAAX;AACD,KAFS,CAAV;AAGA,0BAAYyB,IAAZ,GACGC,KADH,CACS,QADT,EACmBC,EADnB,CACsBH,GADtB,EAEGI,IAFH,CAEQ,UAASC,GAAT,EAAaC,YAAb,EAA0B;AAC9B,UAAGD,GAAH,EAAO;AACLT,gBAAQC,GAAR,CAAYQ,GAAZ;AACD,OAFD,MAGI;AACF,yBAAE5B,IAAF,CAAOR,KAAP,EAAa,UAASU,GAAT,EAAa;AACxB,cAAI4B,mBAAmB,iBAAEN,IAAF,CAAOK,YAAP,EAAqB,UAASb,CAAT,EAAY;AAAE,mBAAOA,EAAEe,MAAF,IAAY7B,IAAIH,KAAvB;AAA8B,WAAjE,CAAvB;AACA,cAAG,CAAC+B,gBAAJ,EAAqB;AACnBA,+BAAmB,EAAEC,QAAQ7B,IAAIH,KAAd,EAAqBiC,MAAM,KAA3B,EAAnB;AACA,kCAAYzD,MAAZ,CAAmBuD,gBAAnB,EAAoC,UAASF,GAAT,EAAaK,MAAb,EAAoB;AACtD,kBAAGL,GAAH,EAAQ;AAAET,wBAAQC,GAAR,CAAYQ,GAAZ;AAAmB;AAC9B,aAFD;AAGD;AACD1B,gBAAM,iBAAEG,KAAF,CAAQH,GAAR,EAAY,EAAC6B,QAAQD,iBAAiB/B,KAA1B,EAAiCiC,MAAMF,iBAAiBE,IAAxD,EAAZ,CAAN;AACD,SATD;AAUAhD,YAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBG,KAArB;AACD;AACF,KAnBH;AAoBD,GAlDD;AAmDD;;AAEM,SAASlB,MAAT,CAAgBS,GAAhB,EAAqBC,GAArB,EAA0B;AAC/B,wBAAYkD,OAAZ,GACGT,KADH,CACS,QADT,EACmBU,MADnB,CAC0BpD,IAAIO,MAAJ,CAAWC,EADrC,EAEGoC,IAFH,CAEQ,UAASC,GAAT,EAAaK,MAAb,EAAoB;AACxB,QAAGL,GAAH,EAAO;AACLT,cAAQC,GAAR,CAAY,KAAZ;AACD,KAFD,MAGI;AACFa,aAAOD,IAAP,GAAcjD,IAAII,IAAJ,CAAS6C,IAAvB;AACAC,aAAOG,IAAP,CAAY,UAASR,GAAT,EAAa1B,GAAb,EAAiB;AAC3BlB,YAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBa,GAArB;AACD,OAFD;AAGD;AACF,GAZH;AAaD;;AAGM,SAAS3B,MAAT,CAAgBQ,GAAhB,EAAqBC,GAArB,EAA0B;AAC/B,MAAIqD,YAAY,iBAAEC,KAAF,CAAQvD,IAAII,IAAJ,CAASK,KAAjB,EACKuB,MADL,CACY,UAASC,CAAT,EAAY;AAAE,WAAOA,EAAEgB,IAAF,IAAU,IAAjB;AAAuB,GADjD,EAEKvC,GAFL,CAES,UAASuB,CAAT,EAAY;AAAE,WAAOA,EAAEjB,KAAT;AAAgB,GAFvC,EAGKF,KAHL,EAAhB;AAIA,MAAI0C,WAAW,iBAAED,KAAF,CAAQvD,IAAII,IAAJ,CAASK,KAAjB,EACMuB,MADN,CACa,UAASC,CAAT,EAAY;AAAE,WAAOA,EAAEgB,IAAF,IAAU,KAAjB;AAAwB,GADnD,EAEMvC,GAFN,CAEU,UAASuB,CAAT,EAAY;AAAE,WAAOA,EAAEjB,KAAT;AAAgB,GAFxC,EAGMF,KAHN,EAAf;AAIA,MAAI2C,UAAU;AACZC,aAAS1D,IAAII,IAAJ,CAASsD,OADN;AAEZJ,eAAWA,SAFC;AAGZE,cAAUA;AAHE,GAAd;AAKA,qBAASG,OAAT,CAAiBF,OAAjB,EAAyB,UAAStD,QAAT,EAAkBC,IAAlB,EAAuB;AAC9CH,QAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBmD,OAArB;AACD,GAFD;AAID","file":"faClient.controller.js","sourcesContent":["'use strict';\nimport faClient from '../../components/faClient';\nimport ProjectFile from './projectFile.model';\n\nimport _ from 'lodash';\nfunction getFiles(cb){\n  var query = {\n    q:'*',\n    limit:0,\n    rows:1000,\n    fl:'score,id,lastModified,fileName,fileSize,NE_SSN,NE_PERSON'\n  }\n  faClient(query,cb);\n}\n// Gets a list of Things\nexport function index(req, res) {\n  faClient.getFacets(function(response,body){\n    res.status(200).send(body);\n\n  })\n}\n\nexport function show(req,res){\n  faClient.getFiles(req.params.id,function(response,body){\n    var files = _.map(JSON.parse(body).docs,function(value){\n      var item = { docId: value.docId };\n      _.each(value.fields,function(obj){\n        var field = {}\n        field[obj.name] = obj.value;\n        item = _.merge(item,field);\n      });\n      item.fullPath = '/' + item.folder.join('/') + '/' + item.fileName;\n      if(item.text_NePos) { item.text_NePos = JSON.parse(item.text_NePos)}\n      item.sensitive = false;\n      if(item.NE_SSN){\n        item.NE_SSN = _.uniq(item.NE_SSN);\n        item.sensitive = true;\n      }\n      else {\n          if(item.text_NePos){\n            var ssnPos = _.filter(item.text_NePos, function(o) { return o.type == \"NE_SSN\" });\n            if(ssnPos && ssnPos.lenght > 0){\n              console.log(ssnPos);\n              item.NE_SSN = _.map(ssnPos.values,function(o) { return o.gloss });\n              item.sensitive = true;\n            }\n          }\n      }\n      return item;\n    });\n    var ids = _.map(files,function(obj){\n      return obj.docId;\n    });\n    ProjectFile.find()\n      .where('cs_uid').in(ids)\n      .exec(function(err,projectFiles){\n        if(err){\n          console.log(err);\n        }\n        else{\n          _.each(files,function(obj){\n            var projectFileMatch = _.find(projectFiles, function(o) { return o.cs_uid == obj.docId });\n            if(!projectFileMatch){\n              projectFileMatch = { cs_uid: obj.docId, keep: false }\n              ProjectFile.create(projectFileMatch,function(err,entity){\n                if(err) { console.log(err); }\n              })\n            }\n            obj = _.merge(obj,{cs_uid: projectFileMatch.docId, keep: projectFileMatch.keep });\n          })\n          res.status(200).send(files);\n        }\n      })\n  });\n}\n\nexport function upsert(req, res) {\n  ProjectFile.findOne()\n    .where('cs_uid').equals(req.params.id)\n    .exec(function(err,entity){\n      if(err){\n        console.log('err')\n      }\n      else{\n        entity.keep = req.body.keep;\n        entity.save(function(err,obj){\n          res.status(200).send(obj);\n        })\n      }\n    })\n}\n\n\nexport function create(req, res) {\n  var moveFiles = _.chain(req.body.files)\n                      .filter(function(o) { return o.keep == true })\n                      .map(function(o) { return o.docId })\n                      .value();\n  var delFiles = _.chain(req.body.files)\n                      .filter(function(o) { return o.keep == false })\n                      .map(function(o) { return o.docId })\n                      .value();\n  var command = {\n    project: req.body.project,\n    moveFiles: moveFiles,\n    delFiles: delFiles,\n  }\n  faClient.archive(command,function(response,body){\n    res.status(200).send(command);\n  });\n\n}\n"]}